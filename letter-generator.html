<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مولد رسالة عرفات - SVG النسخة</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Cairo', 'Tajawal', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif !important;
    background: #f5f5f5 !important;
    min-height: 100vh;
    padding: 1rem;
    direction: rtl;
}

.main-container {
    max-width: 700px;
    margin: 0 auto;
}

.form-container {
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    padding: 2rem;
}

h1 {
    font-size: 1.75rem !important;
    font-weight: 700 !important;
    color: #1a1a1a !important;
    margin-bottom: 0.5rem !important;
    line-height: 1.3 !important;
}

.subtitle {
    font-size: 0.95rem;
    color: #666;
    margin-bottom: 2rem;
    line-height: 1.6;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    font-size: 0.95rem;
    font-weight: 600;
    color: #2d2d2d;
    margin-bottom: 0.5rem;
}

.form-group input[type="text"],
.form-group textarea {
    width: 100%;
    padding: 0.875rem 1rem;
    font-size: 1rem;
    font-family: inherit;
    color: #1a1a1a;
    background: #fafafa;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    transition: all 0.2s ease;
}

.form-group input[type="text"]:focus,
.form-group textarea:focus {
    outline: none;
    background: #ffffff;
    border-color: #2d2d2d;
    box-shadow: 0 0 0 3px rgba(45, 45, 45, 0.05);
}

.form-group input[type="text"]::placeholder,
.form-group textarea::placeholder {
    color: #999;
}

.form-group textarea {
    resize: vertical;
    min-height: 140px;
    line-height: 1.6;
}

.btn-generate {
    width: 100%;
    padding: 1rem 1.5rem;
    font-size: 1.05rem;
    font-weight: 600;
    font-family: inherit;
    color: #ffffff;
    background: #2d2d2d;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    margin-top: 1rem;
}

.btn-generate:hover {
    background: #1a1a1a;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.btn-generate:active {
    transform: translateY(0);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
}

.btn-generate:disabled {
    background: #999;
    cursor: not-allowed;
    transform: none;
}

.loading {
    display: none;
    text-align: center;
    padding: 1rem;
    margin-top: 1rem;
    background: #fff3cd;
    border: 1px solid #ffd966;
    border-radius: 8px;
    color: #856404;
    font-size: 0.95rem;
    font-weight: 500;
}

.loading.active {
    display: block;
}

.note {
    margin-top: 1.5rem;
    padding: 1rem;
    background: #f0f9ff;
    border: 1px solid #b3e0ff;
    border-radius: 8px;
    font-size: 0.9rem;
    color: #0a4d6e;
    line-height: 1.6;
}

        #pdf-container {
            position: absolute;
            left: -9999px;
            width: 2480px;
            height: 3508px;
        }

.note strong {
    font-weight: 700;
    color: #083d54;
}

/* Mobile Responsive */
@media (max-width: 640px) {
    body {
        padding: 0.75rem;
    }

    .form-container {
        padding: 1.5rem;
        border-radius: 10px;
    }

    h1 {
        font-size: 1.5rem !important;
    }

    .subtitle {
        font-size: 0.875rem;
        margin-bottom: 1.5rem;
    }

    .form-group {
        margin-bottom: 1.25rem;
    }

    .form-group label {
        font-size: 0.875rem;
    }

    .form-group input[type="text"],
    .form-group textarea {
        padding: 0.75rem 0.875rem;
        font-size: 0.95rem;
    }

    .btn-generate {
        padding: 0.875rem 1.25rem;
        font-size: 1rem;
    }

    .note {
        font-size: 0.85rem;
        padding: 0.875rem;
    }
}

@media (max-width: 400px) {
    .form-container {
        padding: 1.25rem;
    }

    h1 {
        font-size: 1.35rem !important;
    }
}
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Form Section -->
        <div class="form-container">
            <h1>رسالة عرفات</h1>
            <p class="subtitle"></p>

            <form id="letterForm">
                <div class="form-group">
                    <label for="topRight">رسالة:</label>
                    <input type="text" id="topRight" placeholder="" value="">
                </div>

                <div class="form-group">
                    <label for="topLeft">شهر:</label>
                    <input type="text" id="topLeft" placeholder="" value="">
                </div>

                <div class="form-group">
                    <label for="pageNumber">رقم الصفحة:</label>
                    <input type="text" id="pageNumber" placeholder="" value="">
                </div>

                <div class="form-group">
                    <label for="episodeText">الحلقة:</label>
                    <input type="text" id="episodeText" placeholder="" value="">
                </div>

                <div class="form-group">
                    <label for="mainHeading">العنوان:</label>
                    <input type="text" id="mainHeading" placeholder="" value="">
                </div>

                <div class="form-group">
                    <label for="authorName">اسم المؤلف:</label>
                    <input type="text" id="authorName" placeholder="" value="">
                </div>

                <div class="form-group">
                    <label for="mainContent">المتن:</label>
                    <textarea id="mainContent" rows="6" placeholder=""></textarea>
                </div>

                <button type="submit" class="btn-generate" id="generateBtn">
                     إنشاء وتحميل PDF
                </button>

                <div class="loading" id="loading">
                     جاري إنشاء ملف PDF...
                </div>
            </form>
        </div>
    </div>

    <!-- Hidden container for PDF generation -->
    <div id="pdf-container"></div>

    <script>
        let svgDoc = null;

        // Load SVG template
        async function loadSVG() {
            try {
                const response = await fetch('template-with-text.svg');
                if (!response.ok) throw new Error('Failed to load SVG template');

                const svgText = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(svgText, 'image/svg+xml');

                if (doc.documentElement.nodeName === 'parsererror') {
                    throw new Error('SVG parsing error');
                }

                return doc.documentElement.cloneNode(true);

            } catch (error) {
                console.error('Error loading SVG:', error);
                throw error;
            }
        }

        // Update SVG text elements
        function updateSVGText(svg, formData) {
            // Update text content
            const updates = {
                'topRightText': formData.topRight,
                'topLeftText': formData.topLeft,
                'pageNumberText': formData.pageNumber,
                'episodeText': formData.episodeText,
                'mainHeading': formData.mainHeading,
                'authorNameText': formData.authorName,
                'mainContentText': formData.mainContent
            };

            for (const [id, text] of Object.entries(updates)) {
                const element = svg.getElementById(id);
                if (element) {
                    if (element.tagName === 'text') {
                        element.textContent = text;
                    } else if (element.tagName === 'div') {
                        element.textContent = text;
                    }
                }
            }

            // Auto-resize page number box
            resizePageNumberBox(svg);

            // Auto-resize author box
            resizeAuthorBox(svg);

            return svg;
        }

        // Resize page number box based on text width
        function resizePageNumberBox(svg) {
            try {
                const textElement = svg.getElementById('pageNumberText');
                const boxElement = svg.getElementById('pageNumberBox');

                if (textElement && boxElement) {
                    const bbox = textElement.getBBox();
                    const padding = 40;
                    const newWidth = bbox.width + (padding * 2);
                    const centerX = 1240;

                    boxElement.setAttribute('width', newWidth);
                    boxElement.setAttribute('x', centerX - (newWidth / 2));
                }
            } catch (error) {
                console.warn('Could not resize page number box:', error);
            }
        }

        // Resize author box based on text width
        function resizeAuthorBox(svg) {
            try {
                const textElement = svg.getElementById('authorNameText');
                const boxElement = svg.getElementById('authorBox');

                if (textElement && boxElement) {
                    const bbox = textElement.getBBox();
                    const padding = 60;
                    const newWidth = Math.max(bbox.width + (padding * 2), 400);
                    const centerX = 1240;

                    boxElement.setAttribute('width', newWidth);
                    boxElement.setAttribute('x', centerX - (newWidth / 2));
                }
            } catch (error) {
                console.warn('Could not resize author box:', error);
            }
        }

        // Get form data
        function getFormData() {
            return {
                topRight: document.getElementById('topRight').value || '',
                topLeft: document.getElementById('topLeft').value || '',
                pageNumber: document.getElementById('pageNumber').value || '',
                episodeText: document.getElementById('episodeText').value || '',
                mainHeading: document.getElementById('mainHeading').value || '',
                authorName: document.getElementById('authorName').value || '',
                mainContent: document.getElementById('mainContent').value || ''
            };
        }

        // Generate PDF
        document.getElementById('letterForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const generateBtn = document.getElementById('generateBtn');
            const loading = document.getElementById('loading');

            generateBtn.disabled = true;
            loading.style.display = 'block';

            try {
                // Load fresh SVG for PDF
                svgDoc = await loadSVG();

                // Update with form data
                const formData = getFormData();
                updateSVGText(svgDoc, formData);

                // Set dimensions for PDF
                svgDoc.setAttribute('width', '2480');
                svgDoc.setAttribute('height', '3508');

                // Add to hidden container
                const container = document.getElementById('pdf-container');
                container.innerHTML = '';
                container.appendChild(svgDoc);

                // Wait for rendering
                await new Promise(resolve => setTimeout(resolve, 500));

                // Generate canvas
                console.log('Generating canvas...');
                const canvas = await html2canvas(container, {
                    scale: 3,
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    width: 2480,
                    height: 3508,
                    windowWidth: 2480,
                    windowHeight: 3508,
                    logging: false
                });

                console.log('✓ Canvas created:', canvas.width, 'x', canvas.height);

                // Create PDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4',
                    compress: true
                });

                const imgData = canvas.toDataURL('image/jpeg', 1.0);
                pdf.addImage(imgData, 'JPEG', 0, 0, 210, 297);
                pdf.save('رسالة-عرفات.pdf');

                console.log('✓ PDF saved successfully!');

            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('حدث خطأ أثناء إنشاء PDF:\n\n' + error.message);
            } finally {
                generateBtn.disabled = false;
                loading.style.display = 'none';
            }
        });

    </script>

<script>
        let svgDoc = null;

        // Load SVG template
        async function loadSVG() {
            try {
                const response = await fetch('template-with-text.svg');
                if (!response.ok) throw new Error('Failed to load SVG template');

                const svgText = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(svgText, 'image/svg+xml');

                if (doc.documentElement.nodeName === 'parsererror') {
                    throw new Error('SVG parsing error');
                }

                return doc.documentElement.cloneNode(true);

            } catch (error) {
                console.error('Error loading SVG:', error);
                throw error;
            }
        }

        // Update SVG text elements
        function updateSVGText(svg, formData) {
            // Update text content
            const updates = {
                'topRightText': formData.topRight,
                'topLeftText': formData.topLeft,
                'pageNumberText': formData.pageNumber,
                'episodeText': formData.episodeText,
                'mainHeading': formData.mainHeading,
                'authorNameText': formData.authorName,
                'mainContentText': formData.mainContent
            };

            for (const [id, text] of Object.entries(updates)) {
                const element = svg.getElementById(id);
                if (element) {
                    if (element.tagName === 'text') {
                        element.textContent = text;
                    } else if (element.tagName === 'div') {
                        element.textContent = text;
                    }
                }
            }

            // Auto-resize page number box
            resizePageNumberBox(svg);

            // Auto-resize author box
            resizeAuthorBox(svg);

            return svg;
        }

        // Resize page number box based on text width
        function resizePageNumberBox(svg) {
            try {
                const textElement = svg.getElementById('pageNumberText');
                const boxElement = svg.getElementById('pageNumberBox');

                if (textElement && boxElement) {
                    const bbox = textElement.getBBox();
                    const padding = 40;
                    const newWidth = bbox.width + (padding * 2);
                    const centerX = 1240;

                    boxElement.setAttribute('width', newWidth);
                    boxElement.setAttribute('x', centerX - (newWidth / 2));
                }
            } catch (error) {
                console.warn('Could not resize page number box:', error);
            }
        }

        // Resize author box based on text width
        function resizeAuthorBox(svg) {
            try {
                const textElement = svg.getElementById('authorNameText');
                const boxElement = svg.getElementById('authorBox');

                if (textElement && boxElement) {
                    const bbox = textElement.getBBox();
                    const padding = 60;
                    const newWidth = Math.max(bbox.width + (padding * 2), 400);
                    const centerX = 1240;

                    boxElement.setAttribute('width', newWidth);
                    boxElement.setAttribute('x', centerX - (newWidth / 2));
                }
            } catch (error) {
                console.warn('Could not resize author box:', error);
            }
        }

        // Get form data
        function getFormData() {
            return {
                topRight: document.getElementById('topRight').value || '',
                topLeft: document.getElementById('topLeft').value || '',
                pageNumber: document.getElementById('pageNumber').value || '',
                episodeText: document.getElementById('episodeText').value || '',
                mainHeading: document.getElementById('mainHeading').value || '',
                authorName: document.getElementById('authorName').value || '',
                mainContent: document.getElementById('mainContent').value || ''
            };
        }

        // Generate PDF
        document.getElementById('letterForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const generateBtn = document.getElementById('generateBtn');
            const loading = document.getElementById('loading');

            generateBtn.disabled = true;
            loading.style.display = 'block';

            try {
                // Load fresh SVG for PDF
                svgDoc = await loadSVG();

                // Update with form data
                const formData = getFormData();
                updateSVGText(svgDoc, formData);

                // Set dimensions for PDF
                svgDoc.setAttribute('width', '2480');
                svgDoc.setAttribute('height', '3508');

                // Add to hidden container
                const container = document.getElementById('pdf-container');
                container.innerHTML = '';
                container.appendChild(svgDoc);

                // Wait for rendering
                await new Promise(resolve => setTimeout(resolve, 500));

                // Generate canvas
                console.log('Generating canvas...');
                const canvas = await html2canvas(container, {
                    scale: 3,
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    width: 2480,
                    height: 3508,
                    windowWidth: 2480,
                    windowHeight: 3508,
                    logging: false
                });

                console.log('✓ Canvas created:', canvas.width, 'x', canvas.height);

                // Create PDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4',
                    compress: true
                });

                const imgData = canvas.toDataURL('image/jpeg', 1.0);
                pdf.addImage(imgData, 'JPEG', 0, 0, 210, 297);
                pdf.save('رسالة-عرفات.pdf');

                console.log('✓ PDF saved successfully!');
                alert('✓ تم إنشاء PDF بنجاح!');

            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('حدث خطأ أثناء إنشاء PDF:\n\n' + error.message);
            } finally {
                generateBtn.disabled = false;
                loading.style.display = 'none';
            }
        });
    </script>
</body>
</html>
